{"componentChunkName":"component---src-templates-course-content-template-js","path":"/luku-6/1-aliohjelmat","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"lead","properties":{},"children":[{"type":"text","value":"Aliohjelmat ovat yleisin tapa toteuttaa uudelleenkäytettävää koodia. Aliohjelmien tarkkaa käyttäytymistä kussakin kutsutilanteessa säädellään parametreilla. Esittelemme tässä luvussa aliohjelmien toteutuksen ja käytön esimerkkikoneessa ttk-91."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Aliohjelmat, funktiot, metodit"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://fi.wikipedia.org/wiki/Aliohjelma","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Aliohjelma"}]},{"type":"text","value":" on koodia, jota voidaan "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"kutsumalla"}]},{"type":"text","value":" käyttää mistä tahansa ohjelmiston osasta. Aliohjelmista käytetään eri ohjelmointikielissä myös muita nimiä (proseduuri, funktio, metodi, rutiini), mutta periaate on kaikilla sama. Aliohjelman käyttäytymistä yhdessä kutsutilanteessa säädellään yleensä ainoastaan sen "},{"type":"element","tagName":"a","properties":{"href":"https://www.wikiwand.com/fi/Parametri_(tietotekniikka)","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"parametrien"}]},{"type":"text","value":" avulla, mutta useiden korkean tason kielten ohjelmissa myös aliohjelman suorituksen aikana voidaan viitata globaaleihin (kaikkialla käytössä oleviin) muuttujiin. Aliohjelmat voivat antaa "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"paluuarvon"}]},{"type":"text","value":", jolloin niitä voidaan kutsua yleisesti funktioiksi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Oliokielissä aliohjelmasta käytetään usein nimeä "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"metodi"}]},{"type":"text","value":". Metodeilla voi olla paluuarvo tai sitten ei."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmille on tyypillistä, että niihin sisältyy oma suoritusympäristö. Suoritusympäristöllä tarkoitetaan sitä, että mitkä tunnukset ovat käytettävissä tietyn aliohjelman suorituksen aikana. Yleensä käytettävä korkean tason ohjelmointikieli määrittelee "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"tunnusten näkyvyysalueet"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Esimerkiksi, C-kielessä jonkin aliohjelman suorituksen aikana voi viitata ainoastaan sen aliohjelman omiin tietorakenteisiin ja kaikkiin globaaleihin tietorakenteisiin. Jos pääohjelmasta on kutsuttu aliohjelmaa A, sieltä aliohjelmaa B ja sieltä aliohjelmaa C, niin C:n suorituksen aikana ei voi viitata aliohjelmien A tai B tietorakenteisiin. B:n suorituksen aikana ei voi viitata C:n tietorakenteisiin, eikä niitä ole edes olemassa ennen kuin kontrolli (suoritettavien käskyjen virta) on siirtynyt C:lle."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Jossain ohjelmointikielessä em. esimerkin tapauksessa aliohjelmaa C suoritettaessa myös B:n ja C:n tietorakenteet ovat viitattavissa, kun taas jossain toisessa kielessä tunnusten näkyvyysalueet määräytyvät sen mukaan, miten missä järjestyksessä aliohjelmat sijaitsevat alkuperäisessä koodissa. Emme käsittele näitä tapauksia enempää tällä kurssilla."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Parametrien tyypit"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmien parametreja on kolmen tyyppisiä: arvo-, viite- ja nimiparametrit. Näistä arvo- ja viiteparametrit ovat yleisiä ohjelmointikielissä, mutta nimiparametreja käytetään yleensä vain "},{"type":"element","tagName":"a","properties":{"href":"https://fi.wikipedia.org/wiki/Komentosarjakieli","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"komentokielissä"}]},{"type":"text","value":" (skriptikielissä)."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Arvoparametri"}]},{"type":"text","value":" tarkoittaa, että aliohjelmalle annetaan jonkin lausekkeen "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"arvon kopio"}]},{"type":"text","value":" parametrina. Lauseke voi olla mikä tahansa sopivan tyyppinen aritmeettis-looginen lauseke tai vaikkapa muuttujan arvo. Aliohjelman suorituksen aikana tällaisen parametrin arvoa voi muuttaa, mutta muutos koskee vain parametrina välitettyä lausekkeen (tai muuttujan) arvon kopioita, joten arvoparametrin kautta ei voida muuttaa mitään aliohjelman ulkopuolisia tietoja. Jos muuttuja X välitetään arvoparametrina, niin sen arvo on varmasti ennallaan aliohjelmasta palatessa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Viiteparametria"}]},{"type":"text","value":" käytettäessä parametrina välitetään jokin "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"tiedon osoite"}]},{"type":"text","value":". Se voi olla yksittäisen muuttujan osoite, tai rakenteisen tiedon osoite. Se voi olla myös koodin osoite, kuten esimerkiksi aliohjelman tai metodin osoite. Emme kuitenkaan käsittele tätä mahdollisuutta enää jatkossa. Kutsuva ohjelman osa (pääohjelma tai toinen aliohjelma) välittää hallussaan olevan tiedon osoitteen aliohjelmalle. Tämän osoitteen avulla aliohjelma voi lukea annettua tietoa, mutta se voi myös muuttaa sitä! Aliohjelman paluuarvon lisäksi se voi siis palauttaa arvoja kutsuvalle rutiinille viiteparametrien kautta. Tällaisissa parametreja kutsutaan myös "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ulostuloparametreiksi"}]},{"type":"text","value":". Jos muuttuja X välitetään viiteparametrina, niin sen arvo voi siis olla muuttunut aliohjelmasta palatessa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Toisena esimerkkinä viiteparametrin käytöstä on 16MB kuva, joka on ilmaistu 4096x4096 taulukkona Sue. Taulukon Sue osoite annetaan kuvan käsittelyrutiinille ColorMe, joka kirkastaa annetun kuvan värejä halutulla tavalla. Jos Sue haluttaisiin antaa arvoparametrina, niin se pitäisi kutsun yhteydessä kopioida ColorMe'lle ja kuvan käsittelyn lopuksi uusi kuva (funktion paluuarvona) pitäisi jälleen kopioida kutsuvalle rutiinille. On paljon helpompaa antaa ColorMe'n suoraan lukea ja muuttaa alkuperäistä viiteparametrina annettua kuvaa Sue. Toisaalta tässä on pieni riski, että muut parametrit on valittu huonosti ja ColorMe antaa Sue'lle liian punaiset posket. Sitä varten kuvankäsittelyjärjestelmät ottavat Sue'sta varmuuskopion ennen ColorMe-kutsua, jotta epäonnistunut värikäsittely voidaan tarvittaessa perua."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Nimiparametri"}]},{"type":"text","value":" on aivan erilainen parametrityyppi. Kun arvoparametrillä välitetään tiedon arvo ja viiteparametrillä tiedon osoite, niin nimiparametrilla välitetään itse tieto merkkijonona. Tämä tarkoittaa sitä, että kutsuhetkellä aliohjelmassa käytetyn parametrin nimi (merkkijono) korvataan todellisen parametrilla (toinen merkkijono). Yleisesti ottaen symbolien (esim. parametrin nimi) käsittely tapahtuu ennen suoritusta, kun taas tiedon arvolla ja osoitteella on merkitys vain ovat ohjelman suoritusaikana."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Useimmat ohjelmointikielet eivät salli nimiparametreja, koska aliohjelman koodi pitäisi kääntää (tai tulkita) uudelleen aliohjelman kutsuhetkellä ja se on todettu liian hankalaksi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://fi.wikipedia.org/wiki/Komentosarjakieli","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Skriptikielet"}]},{"type":"text","value":" ja "},{"type":"element","tagName":"a","properties":{"href":"https://fi.wikipedia.org/wiki/Makro","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"makrot"}]},{"type":"text","value":" sen sijaan käsitellään aina tulkitsemalla ja niissä nimiparametrit ovatkin yleisiä. Makrot ovat aliohjelman tapaisia usein toistuvan koodin määrittelyvälineitä, mutta ne laajennetaan koodiksi jo ennen varsinaista käännöstä. Makroilla ei ole omaa suoritusympäristöä, koska niitä ei ole olemassa enää suoritusaikana. Samasta syystä niiden parametreilla ei voi olla suoritusaikaisia ominaisuuksia kuten arvo tai osoite. Ainoaksi parametrityypiksi jää nimiparametri."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Makro Swap(i, j) on mielenkiintoinen esimerkki makroista ja nimiparametrien käytöstä."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"macro Swap (i, j)  -- vaihda i:n ja j:n arvot keskenään\ntmp = i;\ni = j;\nj = tmp;"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tämä näyttää ihan järkevältä ja sitä se onkin, kunhan vain parametrit on valittu sopivasti. Esimerkiksi makro Swap(x,y) laajenee koodiksi"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"tmp = x;\nx = y;\ny = tmp;"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"mikä on juuri se mitä varmaankin haluttiinkin. Jos taas haluttaisiin vaihtaa muuttujan k ja taulukon alkion T[k] arvot keskenään, niin makro Swap(k, T[k]) laajenee koodiksi"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"tmp = k;\nk = T[k];\nT[k] = tmp;"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"jolloin jälkimmäinen T[k] viittaa väärään paikkaan, koska k:n arvo on jo ehtinyt muuttua. Nimiparametrit ovat erilaisia!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tällä kurssilla emme käsittele nimiparametreja tämän enempää, mutta on tärkeä olla tietoinen tästäkin parametrityypistä. Ttk-91:ssä on ainoastaan arvo- ja viiteparametreja."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Aliohjelman toteutuksen osat"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelman toteutuksessa täytyy löytää ratkaisu seuraaviin osaongelmiin."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmille on ominaista, että niitä voidaan kutsua lähes mistä päin tahansa koodia ja että aliohjelman suorituksen jälkeen kontrolli palaa kutsukohdan jälkeiseen konekäskyyn. Tämän toteuttamiseksi joka kutsukerralla "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"paluuosoite"}]},{"type":"text","value":" täytyy tallettaa johonkin. Kaikkia aliohjelmia ei kuitenkaan voi kutsua ihan joka paikasta. Esimerkiksi olio-ohjelmoinnissa olion sisäisiä metodeja voi kutsua vain kyseisen olion muista (julkisista tai sisäisistä) metodeista, koska sisäisten metodien nimet eivät näy olion ulkopuolelle. "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmissa voi olla eri tyyppisiä parametreja ja ne täytyy välittää kutsuvalta rutiinilta aliohjelmalle. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Parametrien välityksen"}]},{"type":"text","value":" pitää tapahtua korkean tason kielen semantiikan mukaisesti. Käytännössä yleensä riittää toteuttaa arvo- ja viiteparametrien välitys oikein. Kutsuva rutiini antaa parametreille alkuarvon ja aliohjelma voi lukea (tai kirjoittaa) niitä. Viiteparametrien kautta aliohjelma pääsee myös lukemaan ja kirjoittamaan muita kutsuvan rutiinin tietoja."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Jos aliohjelma (funktio) palauttaa jonkin arvon, meillä täytyy olla tätä "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"paluuarvoa"}]},{"type":"text","value":" varten oma muistialue. Funktio kirjoittaa paluuarvon sinne ja kutsuva rutiini voi funktiosta paluun jälkeen lukea paluuarvon. Tilanne on hyvin samanlainen kuin arvoparametrin käsittely, mutta tätä tietoa funktio kirjoittaa ja kutsuva rutiini lukee."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Usein aliohjelmassa on omia "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"paikallisia tietorakenteita"}]},{"type":"text","value":", jotka ovat olemassa ja viitattavissa ainoastaan aliohjelman suorituksen aikana. Tällaiset tiedoille pitää dynaamisesti varata muistitilaa joka kutsukerran yhteydessä ja vapauttaa tila aliohjelmasta paluun yhteydessä. Tila ei voi olla staattinen, koska samasta aliohjelmasta voi olla yhtä aikaa usea instanssi (suorituskerta) meneillään. Esimerkiksi "},{"type":"element","tagName":"a","properties":{"href":"https://fi.wikipedia.org/wiki/Rekursio","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"rekursiivisessa aliohjelmassa"}]},{"type":"text","value":" kaikki aliohjelman omat tietorakenteet täytyy varata joka kutsukertaa varten erikseen. Yleensä ohjelmointikielen semantiikka vaatii, että aliohjelman (metodin) tietorakenteet eivät ole viitattavissa muutoin kuin aliohjelman omassa koodissa. Joissakin ohjelmointikielissä aliohjelman paikalliset tietorakenteet (tai osa niistä) talletetaan aliohjelman koodin yhteyteen staattiseen paikkaan. Tuollaisissa kielissä rekursiiviset aliohjelmakutsut eivät ole mahdollisia."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmilla ei saisi olla mitään sivuvaikutuksia. Rekistereiden tasolla tämä tarkoittaa sitä, että kaikkien rekistereiden arvojen täytyy aliohjelmasta paluun yhteydessä olla samat kuin mitä ne olivat kutsuhetkellä. Tämä toteutetaan siten, että aliohjelma "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"tallettaa"}]},{"type":"text","value":" kaikki käyttämänsä "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"rekistereiden arvot"}]},{"type":"text","value":" suorituksensa alussa ja "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"palauttaa arvot"}]},{"type":"text","value":" ennalleen kutsuvaan rutiiniin paluun yhteydessä. Jos esimerkiksi rekisterissä r4 oli muuntelumuuttujan i arvo ennen aliohjelman kutsua, on voitava luottaa siihen, että r4:n arvo on ennallaan aliohjelmasta paluun jälkeen. Kutsuva rutiini voisi tehdä rekistereiden talletuksen tallettamalla kaikki rekisterit ennen aliohjelman kutsua, mutta sen ei kannata tehdä sitä, sillä se ei tiedä mitä rekistereitä kutsuttu aliohjelma käyttää. Lisäksi jos aliohjelma käyttää rekursiota eli kutsuu \"itseään\", myös aliohjelman pitäisi tallettaa rekisterit ennen rekursiivista kutsua. Tämä on kömpelömpää kuin rekistereiden arvojen talletus aliohjelman suorituksen alussa ja ennalleenpalautus aliohjelmasta poistuttaessa."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Aktivaatiotietue (AT)"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmien toteutusmekanismi on aktivaatiotietue (AT, aktivointitietue), joka on suurehko tietorakenne. Eri ohjelmointikielillä AT voi olla vähän erilainen, mutta ne kaikki antavat jonkinlaisen ratkaisun edellä mainittuihin aliohjelmien toteutuksen osaongelmiin. AT talletetaan yleensä muistissa olevaan pinoon."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Myös ttk-91 järjestelmässä AT on talletettu pinoon. Se sisältää seuraavat tiedot, pienemmästä muistiosoitteesta isompaan (ks. alla oleva kuva ttk-91 funktion F aktivaatiotietueesta). Ensimmäisenä siellä on tila mahdollisille paluuarvoille (jos niitä tarvitaan) ja sitten kaikkien parametrien arvot. Arvoparametreistä talletetaan kokonaislukuarvo (koska ttk-91:ssä ei ole liukulukuja) ja viiteparametreistä muistiosoite (joka sekin on kokonaisluku). Seuraavaksi siellä on paluuosoite ja kutsukohdan hetkellä käytössä olleen AT:n osoite (eli vanha FP:n arvo). Tämän jälkeen siellä on tilanvaraukset kaikille aliohjelman paikallisille muuttujille ja muille tietorakenteille. Viimeisenä siellä on tässä aliohjelmassa käytettävien työrekistereiden (R0-R5) kutsuhetken arvot, jotta ne voidaan palauttaa ennalleen aliohjelmasta paluun yhteydessä."}]},{"type":"comment","value":" kuva: ch-6-1-a-aktivaatiotietue    "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"/295ef2c9178d6d108bafe4974531a808/ch-6-1-a-aktivaatiotietue.svg","alt":"Ttk-91 aktivaatiotietue funktiolle F(x,y), F:ssä on paikalliset muuttujat i ja j. F käyttää työrekistereitä r1 ja r2. Kuvassa on pino, joka on kuvattu ylhäältä alaspäin kohti kasvavia muistiosoitteita. Pinossa on päällimmäisenä F:n aktivaatiotietue. Pinon pinnalle osoittaa pinorekisteri SP. Aktivaatiotietueessa on 9 sanaa. Ne ovat paluuarvo, parametrit x ja y, vanha PC ja vanha FP, paikalliset muuttujat i ja j, sekä rekistereiden r1 ja r2 vanhat arvot. Frame pointer FP osoittaa vanhaan FP arvoon. Parametrin y sijainti on FP-2. Paikallisen muuttuja i sijainti on FP+1."},"children":[]}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"illustrations","properties":{"motive":"ch-6-1-a-aktivaatiotietue"},"children":[]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rekisteri FP (Frame Pointer) osoittaa tällä hetkellä käytössä olevaan AT:hen. Normaalisti monisanaiseen tietoon osoitetaan käyttämällä sen ensimmäisen sanan osoitetta koko rakenteen osoitteena. AT:n kohdalla sen osoite on kuitenkin keskellä tietuetta, osoittaen siihen sanaan, johon on talletettu aikaisemman FP:n arvo. \"FP\" on vain toinen nimi rekisterille r7, samalla tavalla kuin \"SP\" on toinen nimi rekisterille r6."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"AT:n koko on vaihteleva, koska parametrien ja paikallisten muuttujien (ym. paikallisten tietorakenteiden) määrä vaihtelee. Joissakin ohjelmointikielissä myös kutsuvan rutiinin tietorakenteet voivat olla viitattavissa. Niihin pääsee helposti käsiksi, koska FP osoittaa suoraan aikaisemman FP:n arvoon ja kutsuvan rutiinin tietorakenteet ovat helposti sen kautta viitattavissa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Parametrien lukumäärä voi vaihdella, mutta niiden suhteellinen sijainti AT:ssä on aina sama. Viimeinen parametri on osoitteessa FP-2, sitä edellinen osoitteessa FP-3, jne. Funktion paluuarvon sijainti on juuri ennen parametreja. Funktion F AT:ssä paluuarvo on osoitteessa FP-4, parametri x on osoitteessa FP-3 ja parametri y on osoitteessa FP-2. Emme tiedä parametrien täsmällisiä muistiosoitteita, mutta niihin pystyy viittaamaan käyttämällä näitä FP-suhteellisia osoitteita. Sitä paitsi eri kutsukerroilla AT:n ja siten myös parametrien sijainti muistissa yleensä vaihtelee."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Paikalliset muuttujat sijaitsevat nekin suhteellisesti aina samassa kohtaa AT:tä, heti FP:n vanhan arvon jälkeen. Esimerkiksi funktiossa F paikallisten muuttujien i ja j osoitteet ovat FP+1 ja FP+2. Emme tiedä täsmällisiä muistiosoitteita myöskään paikallisille tietorakenteille, mutta niihinkin pystyy viittaamaan käyttämällä näitä FP-suhteellisia osoitteita."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"load r1, -2(fp)  ; lataa rekisteriin r1 viimeisen parametrin arvo\nload r2, +2(fp)  ; lataa rekisteriin r2 toisen paikallisen muuttujan arvo"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Viimeisenä aktivaatiotietueessa on sen käyttämien työrekistereiden vanhat arvot. Funktio F käyttää laskennassa rekistereitä r1 ja r2, joten niiden arvot on talletettu aktivaatiotietueen loppuun. Niihin voisi viitata FP kautta käyttäen suhteellisia osoitteita, mutta yleensä niihin viitataan pinorekisterin SP kautta, koska ne sijaitsevat sopivasti pinon pinnalla."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Aktivaatiotietuepino"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aktivaatiotietueet varataan ja vapautetaan dynaamisesti suoritusaikana pinosta sitä mukaa, kun aliohjelmia kutsutaan ja niistä palataan. Alla olevassa esimerkissä on tilanne, jossa pääohjelmasta on kutsuttu aliohjelmaa sum, joka puolestaan on kutsunut funktiota funcA. FP osoittaa funcA:n AT:hen. SP osoittaa pinon pinnalle, jossa on nyt funcA:n aktivaatiotietueen viimeinen alkio. Funktion funcA suorituksenaikana sen kutsuun johtaneet aktivaatiotietueet muodostavat "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"aktivaatiotietuepinon"}]},{"type":"text","value":", joka antaa suorituksessa olevalle ohjelmalle sen hetkisen täydellisen suoritusympäristön. Aktivaatiotietuepino kasvaa yhdellä AT:llä joka aliohjelman kutsukerralla ja vastaavasti pienenee aliohjelmasta palatessa."}]},{"type":"comment","value":" kuva: ch-6-1-b-at-pino  "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"/ab38059943a9a9bb95728af547f929dc/ch-6-1-b-at-pino.svg","alt":"Aktivaatiotietuepino tilanteessa, jossa pääohjelma on kutsunut ohjelmaa sum, joka on kutsunut funktiota funcA. Pinossa on kolme aktivaatiotietuetta (AT). Alimpana pinossa (kuvassa ylimpänä, koska muistisoitteet kasvavat alaspäin) on pääohjelman AT, sen päällä aliohjelman sum AT, ja ylimpänä funtion funcA AT. SP osoittaa funcA:n AT:n päällimmäiseen alkioon ja FP osoittaa funcA:n AT:hen. FP:n osoittamasta paikasta (funcA:n AT:ssä) on linkki aliohjelman sum AT:hen, josta on linkki pääohjelman AT:hen."},"children":[]}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"illustrations","properties":{"motive":"ch-6-1-b-at-pino"},"children":[]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aktivaatiotietue sijaitsee pinossa, joka sijaitsee muistissa. AT:tä rakennetaan ja puretaan tavallisilla konekäskyillä, mutta usein käytetään erityisesti pinon käsittelyyn suunniteltuja konekäskyjä. Joka tapauksessa muistiin viitataan pinorekisterin SP kautta."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Konekäsky push tallettaa pinon pinnalle yhden sanan. Konekäsky pop poistaa sieltä yhden sanan ja tallettaa sen aina rekisteriin."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"push   sp, X   ; sp=sp+1, talleta X:n arvo sp:n osoittamaan muistipaikkaan\npop    sp, r4  ; kopion sp:n osoittama sana r4:een, sp=sp-1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Jos pinosta halutaan poistaa alkioita laittamatta niitä mihinkään, sen voi tehdä vähentämällä SP:n arvoa vastaavasti. Todellisuudessahan myöskään pop-käskyn yhteydessä ei oikeasti poisteta mitään pinosta, vaan ainoastaan kopioidaan sen päällimmäinen arvo johonkin ja vähennetään SP:n arvoa yhdellä."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"sub sp, =1  ; poista pinon päällimmäinen alkio\nsub sp, =5  ; poista pinon 5 päällimmäistä alkiota"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Pinoa voitaisiin käyttää aliohjelmien toteutuksen lisäksi myös laskennan välitulosten tallentamiseen, jolloin push- ja pop-käskyjä käytettäisiin välitulosten kopiointiin pinon ja muiden tietorakenteiden välillä. Tällaisen laskennan yhteydessä ohjelmassa voitaisiin ottaa käyttöön useita pinoja, jolloin push- ja pop-käskyissä voisi käyttää pinorekisterinä myös muita rekistereitä kuin r6:sta. Tällä kurssilla emme kuitenkaan tee näin ja pinoa käytetään ainoastaan aliohjelmien toteutusvälineenä. Viittaamme pinoon aina pinorekisterin SP (Stack Pointer, r6) kautta."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rekistereiden talletuksen ja arvojen palautuksen voi hyvin tehdä push- ja pop-käskyillä. Ttk-91:ssä on tätä tarkoitusta varten myös erikoiskäskyt pushr ja popr, jotka yhdellä konekäskyllä tallettavat kaikkien työrekistereiden r0-r5 arvot pinoon tai palauttavat niiden arvot pinosta. Toisaalta, jos aliohjelma käyttää vain yhtä tai kahta työrekisteriä, niin voi olla turhaa tallettaa ja palauttaa kaikkien työrekistereiden arvoja."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"pushr   sp  ; kopio r0-r5 arvot pinoon, sp=sp+6\npopr    sp  ; palauta r0-r5 arvot pinosta, sp=sp-6"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Todellisissa tietokoneissa on myös muita optimointimenetelmiä, joiden avulla nopeutetaan aliohjelmien käyttöä. Esimerkiksi osa aktivointitietueesta voidaan toteuttaa nopeissa erikoisrekistereissä. Nämä menetelmät eivät kuitenkaan sisälly tämän kurssin oppimistavoitteisiin."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelman kutsukäsky call suorittaa varsinaisen kontrollin siirron aliohjelmaan. Se tallettaa samassa yhteydessä paluuosoitteen ja vanhan FP-arvon pinoon. Kontrollin siirron lisäksi call-käsky asettaa FP:lle uuden arvon, joka sitten osoittaa kutsutun aliohjelman AT:hen. Call-käskyn suorittamisen jälkeen suoritetaan aliohjelman käskyjä. "}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"call  sp, funcA ; talleta PC ja FP pinoon, aseta PC=funcA ja FP=SP"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aliohjelmasta paluukäsky palauttaa kontrollin kutsukohtaan ja samalla palauttaa FP:n ennalleen. Sen lisäksi se poistaa pinosta kutsussa käytetyt parametrit. Exit-käskyn jälkeen suoritetaan jälleen kutsuvan rutiinin konekäskyjä."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"exit sp, =2 ; aseta SP=SP-2, PC = vanha PC, FP = vanha FP"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Suorittimella on yleensä call- ja exit-käskyjen lisäksi käyttöjärjestelmäpalvelujen kutsu- ja paluukäskyt svc ja iret (tms.). Ne toimivat muutoin vastaavalla tavalla, mutta niiden yhteydessä myös suorittimen suoritustila voi vaihtua ja parametrien välitysmenetelmä voi olla erilainen. Käsittelemme käyttöjärjestelmäpalveluiden käyttöä lisää tämän luvun lopussa."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Seuraavassa osiossa näytämme tarkemmin, kuinka näiden käskyjen avulla aktivaatiotietueet täsmällisesti rakennetaan ja puretaan. Se vaatii tarkan protokollan seuraamista sekä kutsuvan rutiinin että aliohjelman osalta."}]},{"type":"comment","value":" quiz 6.1.? "},{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"quiz","properties":{"id":"5cf85628-5597-5849-8248-395527668376"},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"quiz","properties":{"id":"6afaa525-e788-5809-a8b9-1f45ab12ba1a"},"children":[]}]}]},"html":"<div><div>\n<lead>Aliohjelmat ovat yleisin tapa toteuttaa uudelleenkäytettävää koodia. Aliohjelmien tarkkaa käyttäytymistä kussakin kutsutilanteessa säädellään parametreilla. Esittelemme tässä luvussa aliohjelmien toteutuksen ja käytön esimerkkikoneessa ttk-91.</lead>\n</div><h2>Aliohjelmat, funktiot, metodit</h2><p><a href=\"https://fi.wikipedia.org/wiki/Aliohjelma\" target=\"_blank\" rel=\"noopener noreferrer\">Aliohjelma</a> on koodia, jota voidaan <em>kutsumalla</em> käyttää mistä tahansa ohjelmiston osasta. Aliohjelmista käytetään eri ohjelmointikielissä myös muita nimiä (proseduuri, funktio, metodi, rutiini), mutta periaate on kaikilla sama. Aliohjelman käyttäytymistä yhdessä kutsutilanteessa säädellään yleensä ainoastaan sen <a href=\"https://www.wikiwand.com/fi/Parametri_(tietotekniikka)\" target=\"_blank\" rel=\"noopener noreferrer\">parametrien</a> avulla, mutta useiden korkean tason kielten ohjelmissa myös aliohjelman suorituksen aikana voidaan viitata globaaleihin (kaikkialla käytössä oleviin) muuttujiin. Aliohjelmat voivat antaa <em>paluuarvon</em>, jolloin niitä voidaan kutsua yleisesti funktioiksi.</p><p>Oliokielissä aliohjelmasta käytetään usein nimeä <em>metodi</em>. Metodeilla voi olla paluuarvo tai sitten ei.</p><p>Aliohjelmille on tyypillistä, että niihin sisältyy oma suoritusympäristö. Suoritusympäristöllä tarkoitetaan sitä, että mitkä tunnukset ovat käytettävissä tietyn aliohjelman suorituksen aikana. Yleensä käytettävä korkean tason ohjelmointikieli määrittelee <em>tunnusten näkyvyysalueet</em>.</p><p>Esimerkiksi, C-kielessä jonkin aliohjelman suorituksen aikana voi viitata ainoastaan sen aliohjelman omiin tietorakenteisiin ja kaikkiin globaaleihin tietorakenteisiin. Jos pääohjelmasta on kutsuttu aliohjelmaa A, sieltä aliohjelmaa B ja sieltä aliohjelmaa C, niin C:n suorituksen aikana ei voi viitata aliohjelmien A tai B tietorakenteisiin. B:n suorituksen aikana ei voi viitata C:n tietorakenteisiin, eikä niitä ole edes olemassa ennen kuin kontrolli (suoritettavien käskyjen virta) on siirtynyt C:lle.</p><p>Jossain ohjelmointikielessä em. esimerkin tapauksessa aliohjelmaa C suoritettaessa myös B:n ja C:n tietorakenteet ovat viitattavissa, kun taas jossain toisessa kielessä tunnusten näkyvyysalueet määräytyvät sen mukaan, miten missä järjestyksessä aliohjelmat sijaitsevat alkuperäisessä koodissa. Emme käsittele näitä tapauksia enempää tällä kurssilla.</p><h2>Parametrien tyypit</h2><p>Aliohjelmien parametreja on kolmen tyyppisiä: arvo-, viite- ja nimiparametrit. Näistä arvo- ja viiteparametrit ovat yleisiä ohjelmointikielissä, mutta nimiparametreja käytetään yleensä vain <a href=\"https://fi.wikipedia.org/wiki/Komentosarjakieli\" target=\"_blank\" rel=\"noopener noreferrer\">komentokielissä</a> (skriptikielissä).</p><p><em>Arvoparametri</em> tarkoittaa, että aliohjelmalle annetaan jonkin lausekkeen <em>arvon kopio</em> parametrina. Lauseke voi olla mikä tahansa sopivan tyyppinen aritmeettis-looginen lauseke tai vaikkapa muuttujan arvo. Aliohjelman suorituksen aikana tällaisen parametrin arvoa voi muuttaa, mutta muutos koskee vain parametrina välitettyä lausekkeen (tai muuttujan) arvon kopioita, joten arvoparametrin kautta ei voida muuttaa mitään aliohjelman ulkopuolisia tietoja. Jos muuttuja X välitetään arvoparametrina, niin sen arvo on varmasti ennallaan aliohjelmasta palatessa.</p><p><em>Viiteparametria</em> käytettäessä parametrina välitetään jokin <em>tiedon osoite</em>. Se voi olla yksittäisen muuttujan osoite, tai rakenteisen tiedon osoite. Se voi olla myös koodin osoite, kuten esimerkiksi aliohjelman tai metodin osoite. Emme kuitenkaan käsittele tätä mahdollisuutta enää jatkossa. Kutsuva ohjelman osa (pääohjelma tai toinen aliohjelma) välittää hallussaan olevan tiedon osoitteen aliohjelmalle. Tämän osoitteen avulla aliohjelma voi lukea annettua tietoa, mutta se voi myös muuttaa sitä! Aliohjelman paluuarvon lisäksi se voi siis palauttaa arvoja kutsuvalle rutiinille viiteparametrien kautta. Tällaisissa parametreja kutsutaan myös <em>ulostuloparametreiksi</em>. Jos muuttuja X välitetään viiteparametrina, niin sen arvo voi siis olla muuttunut aliohjelmasta palatessa.</p><p>Toisena esimerkkinä viiteparametrin käytöstä on 16MB kuva, joka on ilmaistu 4096x4096 taulukkona Sue. Taulukon Sue osoite annetaan kuvan käsittelyrutiinille ColorMe, joka kirkastaa annetun kuvan värejä halutulla tavalla. Jos Sue haluttaisiin antaa arvoparametrina, niin se pitäisi kutsun yhteydessä kopioida ColorMe'lle ja kuvan käsittelyn lopuksi uusi kuva (funktion paluuarvona) pitäisi jälleen kopioida kutsuvalle rutiinille. On paljon helpompaa antaa ColorMe'n suoraan lukea ja muuttaa alkuperäistä viiteparametrina annettua kuvaa Sue. Toisaalta tässä on pieni riski, että muut parametrit on valittu huonosti ja ColorMe antaa Sue'lle liian punaiset posket. Sitä varten kuvankäsittelyjärjestelmät ottavat Sue'sta varmuuskopion ennen ColorMe-kutsua, jotta epäonnistunut värikäsittely voidaan tarvittaessa perua.</p><p><em>Nimiparametri</em> on aivan erilainen parametrityyppi. Kun arvoparametrillä välitetään tiedon arvo ja viiteparametrillä tiedon osoite, niin nimiparametrilla välitetään itse tieto merkkijonona. Tämä tarkoittaa sitä, että kutsuhetkellä aliohjelmassa käytetyn parametrin nimi (merkkijono) korvataan todellisen parametrilla (toinen merkkijono). Yleisesti ottaen symbolien (esim. parametrin nimi) käsittely tapahtuu ennen suoritusta, kun taas tiedon arvolla ja osoitteella on merkitys vain ovat ohjelman suoritusaikana.</p><p>Useimmat ohjelmointikielet eivät salli nimiparametreja, koska aliohjelman koodi pitäisi kääntää (tai tulkita) uudelleen aliohjelman kutsuhetkellä ja se on todettu liian hankalaksi.</p><p><a href=\"https://fi.wikipedia.org/wiki/Komentosarjakieli\" target=\"_blank\" rel=\"noopener noreferrer\">Skriptikielet</a> ja <a href=\"https://fi.wikipedia.org/wiki/Makro\" target=\"_blank\" rel=\"noopener noreferrer\">makrot</a> sen sijaan käsitellään aina tulkitsemalla ja niissä nimiparametrit ovatkin yleisiä. Makrot ovat aliohjelman tapaisia usein toistuvan koodin määrittelyvälineitä, mutta ne laajennetaan koodiksi jo ennen varsinaista käännöstä. Makroilla ei ole omaa suoritusympäristöä, koska niitä ei ole olemassa enää suoritusaikana. Samasta syystä niiden parametreilla ei voi olla suoritusaikaisia ominaisuuksia kuten arvo tai osoite. Ainoaksi parametrityypiksi jää nimiparametri.</p><p>Makro Swap(i, j) on mielenkiintoinen esimerkki makroista ja nimiparametrien käytöstä.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">macro Swap (i, j)  -- vaihda i:n ja j:n arvot keskenään\ntmp = i;\ni = j;\nj = tmp;</code></pre></div><p>Tämä näyttää ihan järkevältä ja sitä se onkin, kunhan vain parametrit on valittu sopivasti. Esimerkiksi makro Swap(x,y) laajenee koodiksi</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tmp = x;\nx = y;\ny = tmp;</code></pre></div><p>mikä on juuri se mitä varmaankin haluttiinkin. Jos taas haluttaisiin vaihtaa muuttujan k ja taulukon alkion T[k] arvot keskenään, niin makro Swap(k, T[k]) laajenee koodiksi</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tmp = k;\nk = T[k];\nT[k] = tmp;</code></pre></div><p>jolloin jälkimmäinen T[k] viittaa väärään paikkaan, koska k:n arvo on jo ehtinyt muuttua. Nimiparametrit ovat erilaisia!</p><p>Tällä kurssilla emme käsittele nimiparametreja tämän enempää, mutta on tärkeä olla tietoinen tästäkin parametrityypistä. Ttk-91:ssä on ainoastaan arvo- ja viiteparametreja.</p><h2>Aliohjelman toteutuksen osat</h2><p>Aliohjelman toteutuksessa täytyy löytää ratkaisu seuraaviin osaongelmiin.</p><p>Aliohjelmille on ominaista, että niitä voidaan kutsua lähes mistä päin tahansa koodia ja että aliohjelman suorituksen jälkeen kontrolli palaa kutsukohdan jälkeiseen konekäskyyn. Tämän toteuttamiseksi joka kutsukerralla <em>paluuosoite</em> täytyy tallettaa johonkin. Kaikkia aliohjelmia ei kuitenkaan voi kutsua ihan joka paikasta. Esimerkiksi olio-ohjelmoinnissa olion sisäisiä metodeja voi kutsua vain kyseisen olion muista (julkisista tai sisäisistä) metodeista, koska sisäisten metodien nimet eivät näy olion ulkopuolelle. </p><p>Aliohjelmissa voi olla eri tyyppisiä parametreja ja ne täytyy välittää kutsuvalta rutiinilta aliohjelmalle. <em>Parametrien välityksen</em> pitää tapahtua korkean tason kielen semantiikan mukaisesti. Käytännössä yleensä riittää toteuttaa arvo- ja viiteparametrien välitys oikein. Kutsuva rutiini antaa parametreille alkuarvon ja aliohjelma voi lukea (tai kirjoittaa) niitä. Viiteparametrien kautta aliohjelma pääsee myös lukemaan ja kirjoittamaan muita kutsuvan rutiinin tietoja.</p><p>Jos aliohjelma (funktio) palauttaa jonkin arvon, meillä täytyy olla tätä <em>paluuarvoa</em> varten oma muistialue. Funktio kirjoittaa paluuarvon sinne ja kutsuva rutiini voi funktiosta paluun jälkeen lukea paluuarvon. Tilanne on hyvin samanlainen kuin arvoparametrin käsittely, mutta tätä tietoa funktio kirjoittaa ja kutsuva rutiini lukee.</p><p>Usein aliohjelmassa on omia <em>paikallisia tietorakenteita</em>, jotka ovat olemassa ja viitattavissa ainoastaan aliohjelman suorituksen aikana. Tällaiset tiedoille pitää dynaamisesti varata muistitilaa joka kutsukerran yhteydessä ja vapauttaa tila aliohjelmasta paluun yhteydessä. Tila ei voi olla staattinen, koska samasta aliohjelmasta voi olla yhtä aikaa usea instanssi (suorituskerta) meneillään. Esimerkiksi <a href=\"https://fi.wikipedia.org/wiki/Rekursio\" target=\"_blank\" rel=\"noopener noreferrer\">rekursiivisessa aliohjelmassa</a> kaikki aliohjelman omat tietorakenteet täytyy varata joka kutsukertaa varten erikseen. Yleensä ohjelmointikielen semantiikka vaatii, että aliohjelman (metodin) tietorakenteet eivät ole viitattavissa muutoin kuin aliohjelman omassa koodissa. Joissakin ohjelmointikielissä aliohjelman paikalliset tietorakenteet (tai osa niistä) talletetaan aliohjelman koodin yhteyteen staattiseen paikkaan. Tuollaisissa kielissä rekursiiviset aliohjelmakutsut eivät ole mahdollisia.</p><p>Aliohjelmilla ei saisi olla mitään sivuvaikutuksia. Rekistereiden tasolla tämä tarkoittaa sitä, että kaikkien rekistereiden arvojen täytyy aliohjelmasta paluun yhteydessä olla samat kuin mitä ne olivat kutsuhetkellä. Tämä toteutetaan siten, että aliohjelma <em>tallettaa</em> kaikki käyttämänsä <em>rekistereiden arvot</em> suorituksensa alussa ja <em>palauttaa arvot</em> ennalleen kutsuvaan rutiiniin paluun yhteydessä. Jos esimerkiksi rekisterissä r4 oli muuntelumuuttujan i arvo ennen aliohjelman kutsua, on voitava luottaa siihen, että r4:n arvo on ennallaan aliohjelmasta paluun jälkeen. Kutsuva rutiini voisi tehdä rekistereiden talletuksen tallettamalla kaikki rekisterit ennen aliohjelman kutsua, mutta sen ei kannata tehdä sitä, sillä se ei tiedä mitä rekistereitä kutsuttu aliohjelma käyttää. Lisäksi jos aliohjelma käyttää rekursiota eli kutsuu \"itseään\", myös aliohjelman pitäisi tallettaa rekisterit ennen rekursiivista kutsua. Tämä on kömpelömpää kuin rekistereiden arvojen talletus aliohjelman suorituksen alussa ja ennalleenpalautus aliohjelmasta poistuttaessa.</p><h2>Aktivaatiotietue (AT)</h2><p>Aliohjelmien toteutusmekanismi on aktivaatiotietue (AT, aktivointitietue), joka on suurehko tietorakenne. Eri ohjelmointikielillä AT voi olla vähän erilainen, mutta ne kaikki antavat jonkinlaisen ratkaisun edellä mainittuihin aliohjelmien toteutuksen osaongelmiin. AT talletetaan yleensä muistissa olevaan pinoon.</p><p>Myös ttk-91 järjestelmässä AT on talletettu pinoon. Se sisältää seuraavat tiedot, pienemmästä muistiosoitteesta isompaan (ks. alla oleva kuva ttk-91 funktion F aktivaatiotietueesta). Ensimmäisenä siellä on tila mahdollisille paluuarvoille (jos niitä tarvitaan) ja sitten kaikkien parametrien arvot. Arvoparametreistä talletetaan kokonaislukuarvo (koska ttk-91:ssä ei ole liukulukuja) ja viiteparametreistä muistiosoite (joka sekin on kokonaisluku). Seuraavaksi siellä on paluuosoite ja kutsukohdan hetkellä käytössä olleen AT:n osoite (eli vanha FP:n arvo). Tämän jälkeen siellä on tilanvaraukset kaikille aliohjelman paikallisille muuttujille ja muille tietorakenteille. Viimeisenä siellä on tässä aliohjelmassa käytettävien työrekistereiden (R0-R5) kutsuhetken arvot, jotta ne voidaan palauttaa ennalleen aliohjelmasta paluun yhteydessä.</p><!-- kuva: ch-6-1-a-aktivaatiotietue    --><p><img src=\"/295ef2c9178d6d108bafe4974531a808/ch-6-1-a-aktivaatiotietue.svg\" alt=\"Ttk-91 aktivaatiotietue funktiolle F(x,y), F:ssä on paikalliset muuttujat i ja j. F käyttää työrekistereitä r1 ja r2. Kuvassa on pino, joka on kuvattu ylhäältä alaspäin kohti kasvavia muistiosoitteita. Pinossa on päällimmäisenä F:n aktivaatiotietue. Pinon pinnalle osoittaa pinorekisteri SP. Aktivaatiotietueessa on 9 sanaa. Ne ovat paluuarvo, parametrit x ja y, vanha PC ja vanha FP, paikalliset muuttujat i ja j, sekä rekistereiden r1 ja r2 vanhat arvot. Frame pointer FP osoittaa vanhaan FP arvoon. Parametrin y sijainti on FP-2. Paikallisen muuttuja i sijainti on FP+1.\"></p><div>\n<illustrations motive=\"ch-6-1-a-aktivaatiotietue\"></illustrations>\n</div><p>Rekisteri FP (Frame Pointer) osoittaa tällä hetkellä käytössä olevaan AT:hen. Normaalisti monisanaiseen tietoon osoitetaan käyttämällä sen ensimmäisen sanan osoitetta koko rakenteen osoitteena. AT:n kohdalla sen osoite on kuitenkin keskellä tietuetta, osoittaen siihen sanaan, johon on talletettu aikaisemman FP:n arvo. \"FP\" on vain toinen nimi rekisterille r7, samalla tavalla kuin \"SP\" on toinen nimi rekisterille r6.</p><p>AT:n koko on vaihteleva, koska parametrien ja paikallisten muuttujien (ym. paikallisten tietorakenteiden) määrä vaihtelee. Joissakin ohjelmointikielissä myös kutsuvan rutiinin tietorakenteet voivat olla viitattavissa. Niihin pääsee helposti käsiksi, koska FP osoittaa suoraan aikaisemman FP:n arvoon ja kutsuvan rutiinin tietorakenteet ovat helposti sen kautta viitattavissa.</p><p>Parametrien lukumäärä voi vaihdella, mutta niiden suhteellinen sijainti AT:ssä on aina sama. Viimeinen parametri on osoitteessa FP-2, sitä edellinen osoitteessa FP-3, jne. Funktion paluuarvon sijainti on juuri ennen parametreja. Funktion F AT:ssä paluuarvo on osoitteessa FP-4, parametri x on osoitteessa FP-3 ja parametri y on osoitteessa FP-2. Emme tiedä parametrien täsmällisiä muistiosoitteita, mutta niihin pystyy viittaamaan käyttämällä näitä FP-suhteellisia osoitteita. Sitä paitsi eri kutsukerroilla AT:n ja siten myös parametrien sijainti muistissa yleensä vaihtelee.</p><p>Paikalliset muuttujat sijaitsevat nekin suhteellisesti aina samassa kohtaa AT:tä, heti FP:n vanhan arvon jälkeen. Esimerkiksi funktiossa F paikallisten muuttujien i ja j osoitteet ovat FP+1 ja FP+2. Emme tiedä täsmällisiä muistiosoitteita myöskään paikallisille tietorakenteille, mutta niihinkin pystyy viittaamaan käyttämällä näitä FP-suhteellisia osoitteita.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">load r1, -2(fp)  ; lataa rekisteriin r1 viimeisen parametrin arvo\nload r2, +2(fp)  ; lataa rekisteriin r2 toisen paikallisen muuttujan arvo</code></pre></div><p>Viimeisenä aktivaatiotietueessa on sen käyttämien työrekistereiden vanhat arvot. Funktio F käyttää laskennassa rekistereitä r1 ja r2, joten niiden arvot on talletettu aktivaatiotietueen loppuun. Niihin voisi viitata FP kautta käyttäen suhteellisia osoitteita, mutta yleensä niihin viitataan pinorekisterin SP kautta, koska ne sijaitsevat sopivasti pinon pinnalla.</p><h2>Aktivaatiotietuepino</h2><p>Aktivaatiotietueet varataan ja vapautetaan dynaamisesti suoritusaikana pinosta sitä mukaa, kun aliohjelmia kutsutaan ja niistä palataan. Alla olevassa esimerkissä on tilanne, jossa pääohjelmasta on kutsuttu aliohjelmaa sum, joka puolestaan on kutsunut funktiota funcA. FP osoittaa funcA:n AT:hen. SP osoittaa pinon pinnalle, jossa on nyt funcA:n aktivaatiotietueen viimeinen alkio. Funktion funcA suorituksenaikana sen kutsuun johtaneet aktivaatiotietueet muodostavat <em>aktivaatiotietuepinon</em>, joka antaa suorituksessa olevalle ohjelmalle sen hetkisen täydellisen suoritusympäristön. Aktivaatiotietuepino kasvaa yhdellä AT:llä joka aliohjelman kutsukerralla ja vastaavasti pienenee aliohjelmasta palatessa.</p><!-- kuva: ch-6-1-b-at-pino  --><p><img src=\"/ab38059943a9a9bb95728af547f929dc/ch-6-1-b-at-pino.svg\" alt=\"Aktivaatiotietuepino tilanteessa, jossa pääohjelma on kutsunut ohjelmaa sum, joka on kutsunut funktiota funcA. Pinossa on kolme aktivaatiotietuetta (AT). Alimpana pinossa (kuvassa ylimpänä, koska muistisoitteet kasvavat alaspäin) on pääohjelman AT, sen päällä aliohjelman sum AT, ja ylimpänä funtion funcA AT. SP osoittaa funcA:n AT:n päällimmäiseen alkioon ja FP osoittaa funcA:n AT:hen. FP:n osoittamasta paikasta (funcA:n AT:ssä) on linkki aliohjelman sum AT:hen, josta on linkki pääohjelman AT:hen.\"></p><div>\n<illustrations motive=\"ch-6-1-b-at-pino\"></illustrations>\n</div><p>Aktivaatiotietue sijaitsee pinossa, joka sijaitsee muistissa. AT:tä rakennetaan ja puretaan tavallisilla konekäskyillä, mutta usein käytetään erityisesti pinon käsittelyyn suunniteltuja konekäskyjä. Joka tapauksessa muistiin viitataan pinorekisterin SP kautta.</p><p>Konekäsky push tallettaa pinon pinnalle yhden sanan. Konekäsky pop poistaa sieltä yhden sanan ja tallettaa sen aina rekisteriin.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">push   sp, X   ; sp=sp+1, talleta X:n arvo sp:n osoittamaan muistipaikkaan\npop    sp, r4  ; kopion sp:n osoittama sana r4:een, sp=sp-1</code></pre></div><p>Jos pinosta halutaan poistaa alkioita laittamatta niitä mihinkään, sen voi tehdä vähentämällä SP:n arvoa vastaavasti. Todellisuudessahan myöskään pop-käskyn yhteydessä ei oikeasti poisteta mitään pinosta, vaan ainoastaan kopioidaan sen päällimmäinen arvo johonkin ja vähennetään SP:n arvoa yhdellä.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sub sp, =1  ; poista pinon päällimmäinen alkio\nsub sp, =5  ; poista pinon 5 päällimmäistä alkiota</code></pre></div><p>Pinoa voitaisiin käyttää aliohjelmien toteutuksen lisäksi myös laskennan välitulosten tallentamiseen, jolloin push- ja pop-käskyjä käytettäisiin välitulosten kopiointiin pinon ja muiden tietorakenteiden välillä. Tällaisen laskennan yhteydessä ohjelmassa voitaisiin ottaa käyttöön useita pinoja, jolloin push- ja pop-käskyissä voisi käyttää pinorekisterinä myös muita rekistereitä kuin r6:sta. Tällä kurssilla emme kuitenkaan tee näin ja pinoa käytetään ainoastaan aliohjelmien toteutusvälineenä. Viittaamme pinoon aina pinorekisterin SP (Stack Pointer, r6) kautta.</p><p>Rekistereiden talletuksen ja arvojen palautuksen voi hyvin tehdä push- ja pop-käskyillä. Ttk-91:ssä on tätä tarkoitusta varten myös erikoiskäskyt pushr ja popr, jotka yhdellä konekäskyllä tallettavat kaikkien työrekistereiden r0-r5 arvot pinoon tai palauttavat niiden arvot pinosta. Toisaalta, jos aliohjelma käyttää vain yhtä tai kahta työrekisteriä, niin voi olla turhaa tallettaa ja palauttaa kaikkien työrekistereiden arvoja.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pushr   sp  ; kopio r0-r5 arvot pinoon, sp=sp+6\npopr    sp  ; palauta r0-r5 arvot pinosta, sp=sp-6</code></pre></div><p>Todellisissa tietokoneissa on myös muita optimointimenetelmiä, joiden avulla nopeutetaan aliohjelmien käyttöä. Esimerkiksi osa aktivointitietueesta voidaan toteuttaa nopeissa erikoisrekistereissä. Nämä menetelmät eivät kuitenkaan sisälly tämän kurssin oppimistavoitteisiin.</p><p>Aliohjelman kutsukäsky call suorittaa varsinaisen kontrollin siirron aliohjelmaan. Se tallettaa samassa yhteydessä paluuosoitteen ja vanhan FP-arvon pinoon. Kontrollin siirron lisäksi call-käsky asettaa FP:lle uuden arvon, joka sitten osoittaa kutsutun aliohjelman AT:hen. Call-käskyn suorittamisen jälkeen suoritetaan aliohjelman käskyjä. </p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">call  sp, funcA ; talleta PC ja FP pinoon, aseta PC=funcA ja FP=SP</code></pre></div><p>Aliohjelmasta paluukäsky palauttaa kontrollin kutsukohtaan ja samalla palauttaa FP:n ennalleen. Sen lisäksi se poistaa pinosta kutsussa käytetyt parametrit. Exit-käskyn jälkeen suoritetaan jälleen kutsuvan rutiinin konekäskyjä.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">exit sp, =2 ; aseta SP=SP-2, PC = vanha PC, FP = vanha FP</code></pre></div><p>Suorittimella on yleensä call- ja exit-käskyjen lisäksi käyttöjärjestelmäpalvelujen kutsu- ja paluukäskyt svc ja iret (tms.). Ne toimivat muutoin vastaavalla tavalla, mutta niiden yhteydessä myös suorittimen suoritustila voi vaihtua ja parametrien välitysmenetelmä voi olla erilainen. Käsittelemme käyttöjärjestelmäpalveluiden käyttöä lisää tämän luvun lopussa.</p><p>Seuraavassa osiossa näytämme tarkemmin, kuinka näiden käskyjen avulla aktivaatiotietueet täsmällisesti rakennetaan ja puretaan. Se vaatii tarkan protokollan seuraamista sekä kutsuvan rutiinin että aliohjelman osalta.</p><!-- quiz 6.1.? --><div><quiz id=\"5cf85628-5597-5849-8248-395527668376\"></quiz></div>\n<div><quiz id=\"6afaa525-e788-5809-a8b9-1f45ab12ba1a\"></quiz></div></div>","frontmatter":{"path":"/luku-6/1-aliohjelmat","title":"Aliohjelmat, parametrityypit, aktivaatiotietue (AT)"}},"allPages":{"edges":[{"node":{"id":"5b6302a2-c64b-508c-91c4-2db0957cc4b2","frontmatter":{"path":"/arvostelu-ja-kokeet","title":"Arvostelu ja kokeet"}}},{"node":{"id":"799b0272-abdf-59f0-b9b3-03947af42427","frontmatter":{"path":"/credits","title":"Tekijänoikeudet ja lisenssit"}}},{"node":{"id":"82621c5a-f915-50d4-828d-8eede35fdbf7","frontmatter":{"path":"/opettajille","title":"Opettajille ja opinto-ohjaajille"}}},{"node":{"id":"6ed176ef-1be8-53dc-8513-8c4e14a7ce38","frontmatter":{"path":"/osaamistavoitteet","title":"Osaamistavoitteet"}}},{"node":{"id":"2d5ef803-9204-51b7-8d1b-891f29cac1ab","frontmatter":{"path":"/tukivaylat","title":"Tukiväylät"}}},{"node":{"id":"62fa7239-7639-50e3-accb-d209fb4f0984","frontmatter":{"path":"/","title":""}}},{"node":{"id":"9374d347-238d-5d15-a799-d9e134097e9c","frontmatter":{"path":"/usein-kysytyt-kysymykset","title":"Usein kysytyt kysymykset"}}},{"node":{"id":"25d93020-25bf-51eb-97b6-bdc2d0248ede","frontmatter":{"path":"/luku-10/1-tulkitseminen-ohjelman-suoritustapana","title":"Tulkitseminen ohjelman suoritustapana"}}},{"node":{"id":"a49be168-fcf3-5169-95ff-fbb93911c744","frontmatter":{"path":"/luku-10/3-java-ohjelmien-suoritustavat","title":"Java-ohjelmien suoritustavat"}}},{"node":{"id":"96acc546-7537-5245-af40-c0a343f43e57","frontmatter":{"path":"/luku-10/2-java-virtuaalikone","title":"Java virtuaalikone (JVM)"}}},{"node":{"id":"4e1f7d23-545a-578e-8502-1c016428d15a","frontmatter":{"path":"/luku-10/4-emulointi-suorittimen-toteutustapana","title":"Emulointi suorittimen toteutustapana"}}},{"node":{"id":"cc1cb9ab-8bc3-59eb-b373-ef1ef4682363","frontmatter":{"path":"/luku-10","title":"Luku 10: Tulkinta ja emulointi"}}},{"node":{"id":"f1365a76-4fbc-5542-9fa7-f3f1f5216696","frontmatter":{"path":"/luku-5/0-kertaus","title":"Perusteet-kurssin kertaus"}}},{"node":{"id":"22e14f18-d591-5b76-bc01-38d14cd680c5","frontmatter":{"path":"/luku-5/1-ttk-91","title":"Esimerkkitietokone ttk-91"}}},{"node":{"id":"d4832ed4-06c4-5023-94dd-c56d9b3c41aa","frontmatter":{"path":"/luku-5/2-valinta-ja-toistolauseet","title":"Ohjelmoinnin peruskäsitteet sekä valinta- ja toistolauseiden toteutus"}}},{"node":{"id":"668ae475-1d6e-51a8-a31a-18fda782eae4","frontmatter":{"path":"/luku-5/3-rakenteinen-tieto","title":"Rakenteisen tiedon toteutus ja siihen viittaaminen"}}},{"node":{"id":"adc41c13-389b-5ce4-a479-0caa5271449e","frontmatter":{"path":"/luku-5/4-optimoitu-koodi","title":"Optimoitu koodi"}}},{"node":{"id":"0ad1f9dc-df1c-5319-aab2-35699e72ce91","frontmatter":{"path":"/luku-5/5-titokone-titotrainer","title":"Titokone ja TitoTrainer"}}},{"node":{"id":"2373db22-c9f3-579a-83a5-7da1843c4181","frontmatter":{"path":"/luku-5","title":"Luku 5: Konekielinen ohjelmointi"}}},{"node":{"id":"9fb3f792-821e-5683-b13f-aa15c30ea444","frontmatter":{"path":"/luku-6/1-aliohjelmat","title":"Aliohjelmat, parametrityypit, aktivaatiotietue (AT)"}}},{"node":{"id":"b2137737-4997-5b6f-9c79-f81a20870ffe","frontmatter":{"path":"/luku-6/2-akt-tiet-rakentaminen","title":"Aktivaatiotietueen rakentaminen"}}},{"node":{"id":"d73cb6c1-d9fa-55c6-be7f-55c899bef652","frontmatter":{"path":"/luku-6/3-viiteparametrit","title":"Viiteparametrit ja ulostuloparametrit"}}},{"node":{"id":"6b15a20b-2879-57a1-b9a2-321c9c0bdeee","frontmatter":{"path":"/luku-6/4-kj-palvelut","title":"Käyttöjärjestelmäpalvelujen käyttö"}}},{"node":{"id":"9dd0cfca-308d-52e9-b7c9-87bd80b1e3ec","frontmatter":{"path":"/luku-6","title":"Luku 6: Aliohjelmien toteutus"}}},{"node":{"id":"550311b6-6492-58a1-ac20-c4c6ded21215","frontmatter":{"path":"/luku-7/1-vika-virhe-hairio","title":"Vika, virhe ja häiriö"}}},{"node":{"id":"d078f99d-62b5-5564-ba0d-0db0a1a125e9","frontmatter":{"path":"/luku-7/3-muisti-cache-ssd","title":"Järjestelmän sisäisten muistien toteutus"}}},{"node":{"id":"ea808cef-5af4-5657-a911-c57be158f85f","frontmatter":{"path":"/luku-7/2-tiedon-muuttumattomuus","title":"Tiedon muuttumattomuuden turvaaminen"}}},{"node":{"id":"416d64ce-5ffe-5e05-ba25-661028cbe13b","frontmatter":{"path":"/luku-7","title":"Luku 7: Tiedon muuttumattomuus ja erilaiset muistit"}}},{"node":{"id":"e0ee5976-ad00-5b27-8809-adc036d067bc","frontmatter":{"path":"/luku-8/1-muistihierarkia","title":"Muistihierarkia ja virtuaalimuisti"}}},{"node":{"id":"1ceaef01-e5c2-58d4-8898-e980f9d6ac9a","frontmatter":{"path":"/luku-8/2-tiedostot-massamuisti","title":"Tiedostojärjestelmä, tiedostot ja massamuisti"}}},{"node":{"id":"9b30c941-92d6-56de-9b5a-d476a488677a","frontmatter":{"path":"/luku-8/3-io-toteutus","title":"I/O:n toteutus"}}},{"node":{"id":"7967b05d-f768-543f-9069-20c79559cf74","frontmatter":{"path":"/luku-8","title":"Luku 8: Ulkoisen muistin käyttö ja I/O:n toteutus"}}},{"node":{"id":"a4421758-c50f-5cad-8743-46b4fa6d731f","frontmatter":{"path":"/luku-9/1-lausekielesta-suoritukseen","title":"Lausekielestä suoritukseen"}}},{"node":{"id":"d5e20fce-1056-5299-8c49-8e44bc54cdfc","frontmatter":{"path":"/luku-9/2-kaantaminen","title":"Kääntäminen"}}},{"node":{"id":"285cf4c9-0cf8-500b-848d-ad9d9a76ce11","frontmatter":{"path":"/luku-9/3-linkitys","title":"Linkitys"}}},{"node":{"id":"22e4b1ba-4ba7-5aad-98b6-0d4778090bca","frontmatter":{"path":"/luku-9/4-lataus","title":"Lataus"}}},{"node":{"id":"a18c72ea-cb8c-5f68-826e-b2e4ade4c972","frontmatter":{"path":"/luku-9","title":"Luku 9: Käännös, linkitys ja lataus"}}}]}},"pageContext":{}},"staticQueryHashes":["2283872788","994120085"]}