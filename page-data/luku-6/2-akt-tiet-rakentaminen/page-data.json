{"componentChunkName":"component---src-templates-course-content-template-js","path":"/luku-6/2-akt-tiet-rakentaminen","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"lead","properties":{},"children":[{"type":"text","value":"Tässä osiossa käydään läpi protokolla, joka kutsuvan ja kutsutun rutiinin pitää noudattaa aktivaatiotietueiden rakentamisessa ja purkamisessa."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Aktivaatiotietueen rakentaminen ja purku"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Aktivaatiotietueen rakentaminen ja purku tapahtuvat kahdessa vaiheessa. Osan työstä tekee kutsuva rutiini usean konekäskyn avulla ja osan työstä tekee kutsuttu rutiini niin ikään usean konekäskyn avulla."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kutsuva rutiini aloittaa työn ja laittaa pinoon ensin tilan paluuarvolle (jos kyseessä on funktio) ja sitten kaikki parametrien arvot, oman tyyppinsä mukaisesti."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"push sp, =0        ; tila paluuarvolle\npush sp, x         ; arvoparametri esimerkki\npush sp, =x         ; viiteparametri esimerkki"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Seuraavaksi call-käskyllä pinoon laitetaan PC:n nykyarvo eli paluuosoite ja FP nykyarvo eli kutsuvan rutiinin AT:n osoite. Tässä yhteydessä kontrolli siirtyy kutsutulle rutiinille, joka rakentaa sitten loput AT:stä ennen varsinaista laskentatehtäväänsä."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"call sp, funcX     ; pinoon vanha PC ja vanha FP"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kutsuttu rutiini tekee nyt aluksi hallinnolliset alkutoimet, eli "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"prologin"}]},{"type":"text","value":". Siinä varataan tilat paikallisille tietorakenteille ja talletetaan tarvittavien työrekisterien arvot."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"push sp, =0    ; tila ensimmäiselle paikalliselle muuttujalle, alkuarvo 0\npushr sp       ; talleta kaikki työrekisterit"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nyt AT on valmis ja itse rutiinin työ voidaan tehdä. Jos kyseessä on funktio, niin lopuksi pitää paluuarvo tallettaa omalle paikalleen AT:hen."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lopuksi aloitetaan aktivaatiotietueen purku eli "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"epilogi"}]},{"type":"text","value":". Hyvin usein todellisissa symbolisissa konekielissä on tehokkaat "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"makrot"}]},{"type":"text","value":" epilogin ja prologin koodien tuottamiseksi. Ensin palautetaan talletettujen työrekistereiden arvot ja vapautetaan paikallisten tietorakenteiden tilanvaraukset. Lopuksi kontrolli ja suoritusympäristö palautetaan kutsuvalle rutiinille exit-käskyllä, joka samalla vapauttaa parametrien tilanvaraukset pinosta."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"popr sp     ; palauta kaikki työrekisterit\nsub sp, =1  ; vapauta paikallisen muuttujan tilanvaraus\nexit sp, =2 ; palauta PC ja FP pinosta, vapauta 2 parametrin tila"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nyt kontrolli on takaisin kutsuvalla rutiinilla, joka ottaa funktion paluuarvon käyttöönsä pinosta (jos kutsuttu rutiini oli funktio). Näin koko kutsutun rutiinin AT on purettu ja pinon sisältö on täsmälleen sama kuin mitä se oli ennen rutiinin kutsua."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"pop sp, r1  ; poista funktion arvo pinosta rekisteriin r1"}]}]}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Esimerkki funktion toteutuksesta"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Käytetään esimerkkinä kokonaislukuarvoista funktiota fA(x,y), joka käyttää paikallista muuttujaa z (alkuarvo 5) ja palauttaa arvonaan lausekkeen x*z+y arvon."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"int fA (int x, y) {  /* x ja y arvoparametreja */\n    int z = 5;\n\n    z = x * z + y;\n    return(z)\n    }"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Funktiota fA käytetään lauseen t = fA(200, r) toteutukseen, kun r ja t ovat globaaleja muuttujia."}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Kutsuvan rutiinin koodi"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kutsuvassa rutiinissa funktion käyttö tapahtuu konekielellä seuraavanlaisesti."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"r  dc 24      ; r on globaali muuttuja, alkuarvo 24\nt  dc 55      ; t on globaali muuttuja, alkuarvo 55\n   ...\n;\n; toteuta t = fA(200, r)\n;\nk1    push sp, =0   ; tila paluuarvolle\nk2    push sp, =200 ; vakio 200\nk3    push sp, r    ; muuttujan r arvo\nk4    call sp, fA   ; funktion kutsu\nk5    pop sp, r1    ; paluuarvon poisto pinosta\nk6    store r1, t"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ennen funktion kutsun aloittamista (käsky k1) pinossa on kutsuvan rutiinin AT."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"    FP  -->   ??    ; kutsuvan rutiinin AT\n              ...\n    SP -->    ??"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Juuri ennen funktion kutsua (käsky k4) pinossa on paikka paluuarvolle ja parametrit."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"    FP  -->   ??    ; kutsuvan rutiinin AT\n              ...\n              ??\n              0\n              200\n    SP -->    24"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Heti funktiosta palattua (ennen käskyn k5 suoritusta) pinossa on kutsutun rutiinin AT:stä jäljellä vain paluuarvo (jos sitä yleensä oli)."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"    FP  -->   ??    ; kutsuvan rutiinin AT\n              ...\n              ??\n    SP -->    1024  ; funktion paluuarvo"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lopulta käskyn k5 suorittamisen jälkeen pino on ennallaan ja suoritus jatkuu kutsuvan rutiinin ympäristössä."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"    FP  -->   ??    ; kutsuvan rutiinin AT\n              ...\n    SP -->    ??"}]}]}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Kutsutun rutiinin koodi"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Funktio fA() voidaan toteuttaa konekielellä seuraavalla tavalla. Määrittelemme aluksi symbolit paluuarvon, parametrien ja paikallisten tietorakenteiden suhteellisille sijainneille AT:ssä. Kaikki viitteet noihin tietorakenteisiin tehdään sitten noiden symbolien avulla käyttäen niitä suhteellisina osoitteina AT:ssa."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":";\n; funktio fA(x,y)    x ja y ovat arvoparametreja\n;\nretfA equ -4   ; paluuarvon suhteellinen osoite AT:ssa\nparX  equ -3   ; parametrien x ja y suhteelliset osoitteet AT:ssa\nparY  equ -2\nlocZ  equ 1    ; paikallisen muuttujan z suhteellinen osoite AT:ssä\n\nfa    push sp, =0  ; tilanvaraus paikalliselle muuttujalle AT:ssä\n      push sp, r1  ; talleta r1\n\n      load r1, =5  ; alusta Z\nf4    store r1, locZ(fp)  ; viite Z:aan fp:n kautta\n\n      load r1, parX(fp)  ; funktion varsinainen koodi\n      mul r1, locZ(fp)\n      add r1, parY(fp)\n      store r1, locZ(fp)\n\n      store r1, retfA(fp) ; talleta paluuarvo\n\nf10   pop sp, r1   ; palauta r1\n      sub sp, =1   ; vapauta Z:n tilanvaraus\nf12   exit sp, =2  ; paluu kutsuvaan rutiiniin"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kun kontrolli on siirtynyt fA:lle (käsky fa), pinossa on paikka paluuarvolle, parametrit sekä vanha PC ja FP:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"              ??\nvanha FP -->  ...   ; kutsuvan rutiinin AT\n              ??\n              0\n              200\n              24\n              vanha PC\nFP, SP -->    vanha FP"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kun prologi ja paikallisen muuttujan z alustus on tehty (käsky f4), uusi AT on valmis ja pinon sisältö on seuraavanlainen:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"              ??\nvanha FP -->  ...  ; kutsuvan rutiinin AT\n              ??\n              0\n              200\n              24\n              vanha PC\n    FP -->    vanha FP\n              5\n    SP -->    vanha r1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Juuri ennen epilogia (f10) funktion työ on tehty ja paluuarvo on paikallaan:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"              ??\nvanha FP -->  ...  ; kutsuvan rutiinin AT\n              ??\n              1024\n              200\n              24\n              vanha PC\n    FP -->    vanha FP\n              5\n    SP -->    vanha r1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Epilogissa palautetaan r1:n vanha arvo ja vapautetaan Z:n tilanvaraus:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"              ??\nvanha FP -->  ...   ; kutsuvan rutiinin AT\n              ??\n              1024\n              200\n              24\n              vanha PC\nFP, SP -->    vanha FP\n              5\n              vanha r1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lopulta exit-käsky (f12) palauttaa pinosta FP:n ja PC:n arvot ennalleen (ja SP:n arvo vähenee vastaamaan pinosta poistettua määrää eli vähenee kahdella) ja poistaa lisäksi 2 parametria pinosta (tarkemmin ottaen siis vähentää SP:n arvosta 2). Nyt pino-osoitin SP osoittaa funktion paluuarvoon (1024). Tämän jälkeen suoritus siirtyy kutsuvalle rutiinille. Kutsuva rutiini sitten poistaa paluuarvon pinosta (pop sp, r1) ja käyttää haluamallaan tavalla."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"              ??\n      FP -->  ...   ; kutsuvan rutiinin AT\n              ??\n      SP -->  1024\n              200\n              24\n              vanha PC\n              vanha FP\n              5\n              vanha r1"}]}]}]}]},"html":"<div><div>\n<lead>Tässä osiossa käydään läpi protokolla, joka kutsuvan ja kutsutun rutiinin pitää noudattaa aktivaatiotietueiden rakentamisessa ja purkamisessa.</lead>\n</div><h2>Aktivaatiotietueen rakentaminen ja purku</h2><p>Aktivaatiotietueen rakentaminen ja purku tapahtuvat kahdessa vaiheessa. Osan työstä tekee kutsuva rutiini usean konekäskyn avulla ja osan työstä tekee kutsuttu rutiini niin ikään usean konekäskyn avulla.</p><p>Kutsuva rutiini aloittaa työn ja laittaa pinoon ensin tilan paluuarvolle (jos kyseessä on funktio) ja sitten kaikki parametrien arvot, oman tyyppinsä mukaisesti.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">push sp, =0        ; tila paluuarvolle\npush sp, x         ; arvoparametri esimerkki\npush sp, =x         ; viiteparametri esimerkki</code></pre></div><p>Seuraavaksi call-käskyllä pinoon laitetaan PC:n nykyarvo eli paluuosoite ja FP nykyarvo eli kutsuvan rutiinin AT:n osoite. Tässä yhteydessä kontrolli siirtyy kutsutulle rutiinille, joka rakentaa sitten loput AT:stä ennen varsinaista laskentatehtäväänsä.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">call sp, funcX     ; pinoon vanha PC ja vanha FP</code></pre></div><p>Kutsuttu rutiini tekee nyt aluksi hallinnolliset alkutoimet, eli <em>prologin</em>. Siinä varataan tilat paikallisille tietorakenteille ja talletetaan tarvittavien työrekisterien arvot.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">push sp, =0    ; tila ensimmäiselle paikalliselle muuttujalle, alkuarvo 0\npushr sp       ; talleta kaikki työrekisterit</code></pre></div><p>Nyt AT on valmis ja itse rutiinin työ voidaan tehdä. Jos kyseessä on funktio, niin lopuksi pitää paluuarvo tallettaa omalle paikalleen AT:hen.</p><p>Lopuksi aloitetaan aktivaatiotietueen purku eli <em>epilogi</em>. Hyvin usein todellisissa symbolisissa konekielissä on tehokkaat <em>makrot</em> epilogin ja prologin koodien tuottamiseksi. Ensin palautetaan talletettujen työrekistereiden arvot ja vapautetaan paikallisten tietorakenteiden tilanvaraukset. Lopuksi kontrolli ja suoritusympäristö palautetaan kutsuvalle rutiinille exit-käskyllä, joka samalla vapauttaa parametrien tilanvaraukset pinosta.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">popr sp     ; palauta kaikki työrekisterit\nsub sp, =1  ; vapauta paikallisen muuttujan tilanvaraus\nexit sp, =2 ; palauta PC ja FP pinosta, vapauta 2 parametrin tila</code></pre></div><p>Nyt kontrolli on takaisin kutsuvalla rutiinilla, joka ottaa funktion paluuarvon käyttöönsä pinosta (jos kutsuttu rutiini oli funktio). Näin koko kutsutun rutiinin AT on purettu ja pinon sisältö on täsmälleen sama kuin mitä se oli ennen rutiinin kutsua.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pop sp, r1  ; poista funktion arvo pinosta rekisteriin r1</code></pre></div><h2>Esimerkki funktion toteutuksesta</h2><p>Käytetään esimerkkinä kokonaislukuarvoista funktiota fA(x,y), joka käyttää paikallista muuttujaa z (alkuarvo 5) ja palauttaa arvonaan lausekkeen x*z+y arvon.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">int fA (int x, y) {  /* x ja y arvoparametreja */\n    int z = 5;\n\n    z = x * z + y;\n    return(z)\n    }</code></pre></div><p>Funktiota fA käytetään lauseen t = fA(200, r) toteutukseen, kun r ja t ovat globaaleja muuttujia.</p><h3>Kutsuvan rutiinin koodi</h3><p>Kutsuvassa rutiinissa funktion käyttö tapahtuu konekielellä seuraavanlaisesti.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">r  dc 24      ; r on globaali muuttuja, alkuarvo 24\nt  dc 55      ; t on globaali muuttuja, alkuarvo 55\n   ...\n;\n; toteuta t = fA(200, r)\n;\nk1    push sp, =0   ; tila paluuarvolle\nk2    push sp, =200 ; vakio 200\nk3    push sp, r    ; muuttujan r arvo\nk4    call sp, fA   ; funktion kutsu\nk5    pop sp, r1    ; paluuarvon poisto pinosta\nk6    store r1, t</code></pre></div><p>Ennen funktion kutsun aloittamista (käsky k1) pinossa on kutsuvan rutiinin AT.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    FP  --&gt;   ??    ; kutsuvan rutiinin AT\n              ...\n    SP --&gt;    ??</code></pre></div><p>Juuri ennen funktion kutsua (käsky k4) pinossa on paikka paluuarvolle ja parametrit.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    FP  --&gt;   ??    ; kutsuvan rutiinin AT\n              ...\n              ??\n              0\n              200\n    SP --&gt;    24</code></pre></div><p>Heti funktiosta palattua (ennen käskyn k5 suoritusta) pinossa on kutsutun rutiinin AT:stä jäljellä vain paluuarvo (jos sitä yleensä oli).</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    FP  --&gt;   ??    ; kutsuvan rutiinin AT\n              ...\n              ??\n    SP --&gt;    1024  ; funktion paluuarvo</code></pre></div><p>Lopulta käskyn k5 suorittamisen jälkeen pino on ennallaan ja suoritus jatkuu kutsuvan rutiinin ympäristössä.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    FP  --&gt;   ??    ; kutsuvan rutiinin AT\n              ...\n    SP --&gt;    ??</code></pre></div><h3>Kutsutun rutiinin koodi</h3><p>Funktio fA() voidaan toteuttaa konekielellä seuraavalla tavalla. Määrittelemme aluksi symbolit paluuarvon, parametrien ja paikallisten tietorakenteiden suhteellisille sijainneille AT:ssä. Kaikki viitteet noihin tietorakenteisiin tehdään sitten noiden symbolien avulla käyttäen niitä suhteellisina osoitteina AT:ssa.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">;\n; funktio fA(x,y)    x ja y ovat arvoparametreja\n;\nretfA equ -4   ; paluuarvon suhteellinen osoite AT:ssa\nparX  equ -3   ; parametrien x ja y suhteelliset osoitteet AT:ssa\nparY  equ -2\nlocZ  equ 1    ; paikallisen muuttujan z suhteellinen osoite AT:ssä\n\nfa    push sp, =0  ; tilanvaraus paikalliselle muuttujalle AT:ssä\n      push sp, r1  ; talleta r1\n\n      load r1, =5  ; alusta Z\nf4    store r1, locZ(fp)  ; viite Z:aan fp:n kautta\n\n      load r1, parX(fp)  ; funktion varsinainen koodi\n      mul r1, locZ(fp)\n      add r1, parY(fp)\n      store r1, locZ(fp)\n\n      store r1, retfA(fp) ; talleta paluuarvo\n\nf10   pop sp, r1   ; palauta r1\n      sub sp, =1   ; vapauta Z:n tilanvaraus\nf12   exit sp, =2  ; paluu kutsuvaan rutiiniin</code></pre></div><p>Kun kontrolli on siirtynyt fA:lle (käsky fa), pinossa on paikka paluuarvolle, parametrit sekä vanha PC ja FP:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">              ??\nvanha FP --&gt;  ...   ; kutsuvan rutiinin AT\n              ??\n              0\n              200\n              24\n              vanha PC\nFP, SP --&gt;    vanha FP</code></pre></div><p>Kun prologi ja paikallisen muuttujan z alustus on tehty (käsky f4), uusi AT on valmis ja pinon sisältö on seuraavanlainen:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">              ??\nvanha FP --&gt;  ...  ; kutsuvan rutiinin AT\n              ??\n              0\n              200\n              24\n              vanha PC\n    FP --&gt;    vanha FP\n              5\n    SP --&gt;    vanha r1</code></pre></div><p>Juuri ennen epilogia (f10) funktion työ on tehty ja paluuarvo on paikallaan:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">              ??\nvanha FP --&gt;  ...  ; kutsuvan rutiinin AT\n              ??\n              1024\n              200\n              24\n              vanha PC\n    FP --&gt;    vanha FP\n              5\n    SP --&gt;    vanha r1</code></pre></div><p>Epilogissa palautetaan r1:n vanha arvo ja vapautetaan Z:n tilanvaraus:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">              ??\nvanha FP --&gt;  ...   ; kutsuvan rutiinin AT\n              ??\n              1024\n              200\n              24\n              vanha PC\nFP, SP --&gt;    vanha FP\n              5\n              vanha r1</code></pre></div><p>Lopulta exit-käsky (f12) palauttaa pinosta FP:n ja PC:n arvot ennalleen (ja SP:n arvo vähenee vastaamaan pinosta poistettua määrää eli vähenee kahdella) ja poistaa lisäksi 2 parametria pinosta (tarkemmin ottaen siis vähentää SP:n arvosta 2). Nyt pino-osoitin SP osoittaa funktion paluuarvoon (1024). Tämän jälkeen suoritus siirtyy kutsuvalle rutiinille. Kutsuva rutiini sitten poistaa paluuarvon pinosta (pop sp, r1) ja käyttää haluamallaan tavalla.</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">              ??\n      FP --&gt;  ...   ; kutsuvan rutiinin AT\n              ??\n      SP --&gt;  1024\n              200\n              24\n              vanha PC\n              vanha FP\n              5\n              vanha r1</code></pre></div></div>","frontmatter":{"path":"/luku-6/2-akt-tiet-rakentaminen","title":"Aktivaatiotietueen rakentaminen"}},"allPages":{"edges":[{"node":{"id":"5b6302a2-c64b-508c-91c4-2db0957cc4b2","frontmatter":{"path":"/arvostelu-ja-kokeet","title":"Arvostelu ja kokeet"}}},{"node":{"id":"799b0272-abdf-59f0-b9b3-03947af42427","frontmatter":{"path":"/credits","title":"Tekijänoikeudet ja lisenssit"}}},{"node":{"id":"82621c5a-f915-50d4-828d-8eede35fdbf7","frontmatter":{"path":"/opettajille","title":"Opettajille ja opinto-ohjaajille"}}},{"node":{"id":"6ed176ef-1be8-53dc-8513-8c4e14a7ce38","frontmatter":{"path":"/osaamistavoitteet","title":"Osaamistavoitteet"}}},{"node":{"id":"2d5ef803-9204-51b7-8d1b-891f29cac1ab","frontmatter":{"path":"/tukivaylat","title":"Tukiväylät"}}},{"node":{"id":"62fa7239-7639-50e3-accb-d209fb4f0984","frontmatter":{"path":"/","title":""}}},{"node":{"id":"9374d347-238d-5d15-a799-d9e134097e9c","frontmatter":{"path":"/usein-kysytyt-kysymykset","title":"Usein kysytyt kysymykset"}}},{"node":{"id":"25d93020-25bf-51eb-97b6-bdc2d0248ede","frontmatter":{"path":"/luku-10/1-tulkitseminen-ohjelman-suoritustapana","title":"Tulkitseminen ohjelman suoritustapana"}}},{"node":{"id":"96acc546-7537-5245-af40-c0a343f43e57","frontmatter":{"path":"/luku-10/2-java-virtuaalikone","title":"Java virtuaalikone (JVM)"}}},{"node":{"id":"a49be168-fcf3-5169-95ff-fbb93911c744","frontmatter":{"path":"/luku-10/3-java-ohjelmien-suoritustavat","title":"Java-ohjelmien suoritustavat"}}},{"node":{"id":"4e1f7d23-545a-578e-8502-1c016428d15a","frontmatter":{"path":"/luku-10/4-emulointi-suorittimen-toteutustapana","title":"Emulointi suorittimen toteutustapana"}}},{"node":{"id":"cc1cb9ab-8bc3-59eb-b373-ef1ef4682363","frontmatter":{"path":"/luku-10","title":"Luku 10: Tulkinta ja emulointi"}}},{"node":{"id":"f1365a76-4fbc-5542-9fa7-f3f1f5216696","frontmatter":{"path":"/luku-5/0-kertaus","title":"Perusteet-kurssin kertaus"}}},{"node":{"id":"22e14f18-d591-5b76-bc01-38d14cd680c5","frontmatter":{"path":"/luku-5/1-ttk-91","title":"Esimerkkitietokone ttk-91"}}},{"node":{"id":"d4832ed4-06c4-5023-94dd-c56d9b3c41aa","frontmatter":{"path":"/luku-5/2-valinta-ja-toistolauseet","title":"Ohjelmoinnin peruskäsitteet sekä valinta- ja toistolauseiden toteutus"}}},{"node":{"id":"adc41c13-389b-5ce4-a479-0caa5271449e","frontmatter":{"path":"/luku-5/4-optimoitu-koodi","title":"Optimoitu koodi"}}},{"node":{"id":"668ae475-1d6e-51a8-a31a-18fda782eae4","frontmatter":{"path":"/luku-5/3-rakenteinen-tieto","title":"Rakenteisen tiedon toteutus ja siihen viittaaminen"}}},{"node":{"id":"0ad1f9dc-df1c-5319-aab2-35699e72ce91","frontmatter":{"path":"/luku-5/5-titokone-titotrainer","title":"Titokone ja TitoTrainer"}}},{"node":{"id":"2373db22-c9f3-579a-83a5-7da1843c4181","frontmatter":{"path":"/luku-5","title":"Luku 5: Konekielinen ohjelmointi"}}},{"node":{"id":"9fb3f792-821e-5683-b13f-aa15c30ea444","frontmatter":{"path":"/luku-6/1-aliohjelmat","title":"Aliohjelmat, parametrityypit, aktivaatiotietue (AT)"}}},{"node":{"id":"b2137737-4997-5b6f-9c79-f81a20870ffe","frontmatter":{"path":"/luku-6/2-akt-tiet-rakentaminen","title":"Aktivaatiotietueen rakentaminen"}}},{"node":{"id":"d73cb6c1-d9fa-55c6-be7f-55c899bef652","frontmatter":{"path":"/luku-6/3-viiteparametrit","title":"Viiteparametrit ja ulostuloparametrit"}}},{"node":{"id":"6b15a20b-2879-57a1-b9a2-321c9c0bdeee","frontmatter":{"path":"/luku-6/4-kj-palvelut","title":"Käyttöjärjestelmäpalvelujen käyttö"}}},{"node":{"id":"9dd0cfca-308d-52e9-b7c9-87bd80b1e3ec","frontmatter":{"path":"/luku-6","title":"Luku 6: Aliohjelmien toteutus"}}},{"node":{"id":"d078f99d-62b5-5564-ba0d-0db0a1a125e9","frontmatter":{"path":"/luku-7/3-muisti-cache-ssd","title":"Järjestelmän sisäisten muistien toteutus"}}},{"node":{"id":"ea808cef-5af4-5657-a911-c57be158f85f","frontmatter":{"path":"/luku-7/2-tiedon-muuttumattomuus","title":"Tiedon muuttumattomuuden turvaaminen"}}},{"node":{"id":"416d64ce-5ffe-5e05-ba25-661028cbe13b","frontmatter":{"path":"/luku-7","title":"Luku 7: Tiedon muuttumattomuus ja erilaiset muistit"}}},{"node":{"id":"e0ee5976-ad00-5b27-8809-adc036d067bc","frontmatter":{"path":"/luku-8/1-muistihierarkia","title":"Muistihierarkia ja virtuaalimuisti"}}},{"node":{"id":"1ceaef01-e5c2-58d4-8898-e980f9d6ac9a","frontmatter":{"path":"/luku-8/2-tiedostot-massamuisti","title":"Tiedostojärjestelmä, tiedostot ja massamuisti"}}},{"node":{"id":"9b30c941-92d6-56de-9b5a-d476a488677a","frontmatter":{"path":"/luku-8/3-io-toteutus","title":"I/O:n toteutus"}}},{"node":{"id":"7967b05d-f768-543f-9069-20c79559cf74","frontmatter":{"path":"/luku-8","title":"Luku 8: Ulkoisen muistin käyttö ja I/O:n toteutus"}}},{"node":{"id":"a4421758-c50f-5cad-8743-46b4fa6d731f","frontmatter":{"path":"/luku-9/1-lausekielesta-suoritukseen","title":"Lausekielestä suoritukseen"}}},{"node":{"id":"d5e20fce-1056-5299-8c49-8e44bc54cdfc","frontmatter":{"path":"/luku-9/2-kaantaminen","title":"Kääntäminen"}}},{"node":{"id":"285cf4c9-0cf8-500b-848d-ad9d9a76ce11","frontmatter":{"path":"/luku-9/3-linkitys","title":"Linkitys"}}},{"node":{"id":"22e4b1ba-4ba7-5aad-98b6-0d4778090bca","frontmatter":{"path":"/luku-9/4-lataus","title":"Lataus"}}},{"node":{"id":"a18c72ea-cb8c-5f68-826e-b2e4ade4c972","frontmatter":{"path":"/luku-9","title":"Luku 9: Käännös, linkitys ja lataus"}}},{"node":{"id":"550311b6-6492-58a1-ac20-c4c6ded21215","frontmatter":{"path":"/luku-7/1-vika-virhe-hairio","title":"Vika, virhe ja häiriö"}}}]}},"pageContext":{}},"staticQueryHashes":["2283872788","994120085"]}